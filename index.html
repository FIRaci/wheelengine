<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wheel Engine - v4.5 (Final)</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style type="text/css">
        #logic-map-container { width: 100%; height: 100%; background-color: #1a1a1a; border-radius: 10px; }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1>Wheel Engine</h1>
            <nav class="main-nav">
                <button class="nav-link active" data-page="wheel-studio">Studio Vòng Quay</button>
                <button class="nav-link" data-page="logic-brain">Bộ Não Logic</button>
            </nav>
            <div class="header-actions">
                <button id="import-btn" class="btn btn-secondary">Import Dự Án</button>
                <button id="export-btn" class="btn btn-secondary">Export Dự Án</button>
                <input type="file" id="import-file-input" accept=".json" style="display: none;">
            </div>
        </header>

        <main class="app-main">
            <!-- PAGE 1: WHEEL STUDIO -->
            <div id="wheel-studio-page" class="app-page active">
                <div class="creator-panel">
                    <div id="panel-overlay"></div>
                    <div class="panel-content-wrapper">
                         <div class="panel-section">
                            <h2>Quản Lý Vòng Quay</h2>
                            <div class="form-group">
                                <label for="wheel-selector">Chọn Vòng Quay</label>
                                <div style="display: flex; gap: 10px;">
                                    <select id="wheel-selector" style="flex-grow: 1;"></select>
                                    <button id="delete-wheel-btn" class="btn btn-danger" title="Xóa vòng quay">Xóa</button>
                                </div>
                            </div>
                            <div class="btn-container">
                                <button id="copy-wheel-btn" class="btn btn-secondary">Copy Vòng Quay</button>
                                <button id="paste-wheel-btn" class="btn btn-secondary" disabled>Paste Vòng Quay</button>
                            </div>
                            <hr>
                            <div class="form-group"><label for="new-wheel-name">Tên Vòng Quay Mới</label><input type="text" id="new-wheel-name" placeholder="VD: Vũ Khí, Kỹ Năng..."></div>
                            <button id="create-wheel-btn" class="btn btn-primary">Tạo Mới</button>
                        </div>
                        <div class="panel-section" id="wheel-settings-panel">
                             <h3 id="wheel-settings-title">Cài Đặt Vòng Quay</h3>
                            <div class="form-group"><label for="spin-count-variable">Biến Số Lần Quay</label><input type="text" id="spin-count-variable" list="variable-suggestions-settings" placeholder="VD: so_lan_quay"></div>
                            <div class="form-group">
                                <label for="segment-removal-mode">Chế độ xóa ô sau khi trúng</label>
                                <select id="segment-removal-mode">
                                    <option value="none">Không xóa</option>
                                    <option value="temporary">Xóa Tạm Thời (Trong chuỗi quay)</option>
                                    <option value="permanent">Xóa Vĩnh Viễn (Hủy diệt)</option>
                                </select>
                            </div>
                            <div class="form-group"><label for="default-link">Liên kết mặc định</label><select id="default-link"></select></div>
                             <hr>
                             <h4>Cài đặt Âm thanh</h4>
                             <div class="form-group">
                                 <label for="tick-sound-upload">File âm thanh "Tick"</label>
                                 <div class="file-input-group">
                                    <input type="file" id="tick-sound-upload" class="audio-upload-input" accept="audio/*">
                                    <button id="clear-tick-sound-btn" class="delete-btn">X</button>
                                 </div>
                             </div>
                        </div>
                        <div class="panel-section">
                            <h3 id="segment-editor-title">Chỉnh Sửa Ô</h3>
                             <div class="form-group"><label for="segment-text">Nội dung ô</label><input type="text" id="segment-text" placeholder="VD: Human, Elf, 10..."></div>
                            <div class="form-row">
                                <div class="form-group" style="flex-grow: 1;"><label for="segment-weight">Tỷ lệ (Trọng số)</label><input type="number" id="segment-weight" value="1" min="1"></div>
                                <div class="form-group"><label for="segment-color">Màu sắc</label><input type="color" id="segment-color" value="#8AC926"></div>
                            </div>
                            <div id="segment-action-panel">
                                <h4>Hành Động Kích Hoạt</h4>
                                 <div class="action-group">
                                    <div class="action-header">
                                        <input type="checkbox" id="action-setVariable-enabled" class="custom-checkbox">
                                        <label for="action-setVariable-enabled">Gán Giá Trị cho Biến</label>
                                        <span class="action-summary"></span>
                                    </div>
                                    <div class="action-details" id="action-setVariable-details"><div id="set-variable-actions-container"></div><button id="add-set-variable-action-btn" class="btn btn-secondary btn-add-action">+ Thêm hành động</button></div>
                                </div>
                                <div class="action-group">
                                    <div class="action-header">
                                        <input type="checkbox" id="action-goToWheel-enabled" class="custom-checkbox">
                                        <label for="action-goToWheel-enabled">Chuyển đến Vòng Quay</label>
                                        <span class="action-summary"></span>
                                    </div>
                                    <div class="action-details" id="action-goToWheel-details"><select id="action-target-wheel"></select></div>
                                </div>
                                 <div class="action-group">
                                    <div class="action-header">
                                        <input type="checkbox" id="action-playSound-enabled" class="custom-checkbox">
                                        <label for="action-playSound-enabled">Phát Âm thanh</label>
                                        <span class="action-summary"></span>
                                    </div>
                                    <div class="action-details" id="action-playSound-details">
                                        <div class="file-input-group">
                                            <input type="file" id="action-sound-upload" class="audio-upload-input" accept="audio/*">
                                            <button id="clear-action-sound-btn" class="delete-btn">X</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="action-group">
                                    <div class="action-header">
                                        <input type="checkbox" id="action-conditional-enabled" class="custom-checkbox">
                                        <label for="action-conditional-enabled">Điều Kiện Quay Lại (Bảo Hiểm)</label>
                                        <span class="action-summary"></span>
                                    </div>
                                    <div class="action-details" id="action-conditional-details">
                                       <p class="condition-text">Nếu kết quả vòng quay sau là:</p>
                                       <div class="condition-row"><select id="condition-operator"><option value="<=">&lt;=</option><option value=">=">&gt;=</option><option value="==">==</option><option value="<">&lt;</option><option value=">">&gt;</option></select><input type="number" id="condition-value" value="3"></div>
                                       <p class="condition-text">thì được quay lại tối đa:</p>
                                       <div class="condition-row"><input type="number" id="condition-rerolls" value="1" min="1"><span>lần.</span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="btn-container"><button id="copy-actions-btn" class="btn btn-secondary" title="Sao chép">Copy Hành Động</button><button id="paste-actions-btn" class="btn btn-secondary" title="Dán" disabled>Paste Hành Động</button></div>
                            <div class="btn-container"><button id="main-action-btn" class="btn btn-primary">Thêm Ô</button><button id="cancel-edit-btn" class="btn btn-secondary" style="display: none;">Hủy</button></div>
                            <h4 style="margin-top: 1.5rem;">Các ô hiện tại</h4>
                            <p id="total-weight-info"></p>
                            <ul id="segment-list"></ul>
                        </div>
                    </div>
                </div>
                <div class="viewer-panel">
                    <div class="wheel-display-area">
                        <h1 id="wheel-title"></h1>
                        <h3 id="spin-count-display"></h3>
                        <div class="wheel-container"><div class="wheel-marker"></div><canvas id="wheel-canvas" width="500" height="500"></canvas></div>
                        <div class="viewer-actions">
                            <button id="spin-button" class="btn btn-primary">QUAY!</button>
                            <button id="reset-spin-btn" class="btn btn-danger">Dừng & Hoàn Tác</button>
                        </div>
                    </div>
                    <div class="viewer-sidebar">
                        <div class="panel-section">
                             <h2>Thực Thể Hoạt Động</h2>
                             <div class="form-group" id="active-entity-container">
                                <select id="active-entity-selector">
                                    <option value="none">-- Không có --</option>
                                </select>
                            </div>
                        </div>
                        <div class="panel-section" id="character-sheet-panel">
                            <h2>Thông Tin & Nhật Ký</h2>
                            <div id="entity-stats-display"></div>
                            <hr>
                            <h3 class="log-title">Nhật ký sự kiện</h3>
                            <ul id="game-log"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE 2: LOGIC BRAIN -->
            <div id="logic-brain-page" class="app-page">
                <nav class="logic-sub-nav">
                    <button class="sub-nav-link active" data-subpage="templates-rules">Biến Mẫu & Luật Chơi</button>
                    <button class="sub-nav-link" data-subpage="entities">Quản Lý Thực Thể</button>
                    <button class="sub-nav-link" data-subpage="logic-map">Sơ Đồ Logic</button>
                </nav>
                <div id="templates-rules-subpage" class="logic-sub-page active">
                    <div class="logic-sidebar">
                        <div class="panel-section">
                            <h2>Biến Mẫu (Template)</h2>
                            <p class="form-hint">Đây là cấu trúc biến mặc định cho mọi Thực Thể mới.</p>
                            <div id="variable-template-list"></div>
                            <hr>
                            <div class="form-group">
                                <label for="new-variable-name">Tên biến mới</label>
                                <input type="text" id="new-variable-name" placeholder="VD: vu_khi, kinh_nghiem...">
                            </div>
                            <div class="form-group">
                                <label for="new-variable-value">Giá trị Gốc (Base)</label>
                                <input type="text" id="new-variable-value" value="0">
                            </div>
                            <div class="form-group">
                                <label for="new-variable-icon-upload">Icon (Tùy chọn)</label>
                                <input type="file" id="new-variable-icon-upload" class="image-upload-input" accept="image/*">
                            </div>
                            <button id="add-variable-btn" class="btn btn-primary">Thêm Biến Mẫu</button>
                        </div>
                        <div class="panel-section">
                            <h2>Biến Tính Toán</h2>
                            <ul id="computed-variables-list"></ul>
                            <hr>
                            <button id="add-computed-variable-btn" class="btn btn-primary">Thêm Biến Tính Toán</button>
                        </div>
                        <div class="panel-section">
                            <h2>Luật Điều Kiện</h2>
                            <ul id="rules-list"></ul>
                            <hr>
                            <button id="add-rule-btn" class="btn btn-primary">Thêm Luật Mới</button>
                        </div>
                    </div>
                    <div id="logic-editor" class="panel-section">
                        <div id="computed-variable-editor-content" style="display: none;">
                            <h2 id="computed-variable-editor-title">Chỉnh Sửa Biến Tính Toán</h2>
                            <div class="form-group"> <label>Công thức</label> <input type="text" id="computed-variable-formula" placeholder="VD: suc_manh_base + nhanh_nhen_base"> <p class="form-hint">Biến tính toán sẽ có tên là <br> [tên_biến_1] + [tên_biến_2]... </p> </div>
                        </div>
                        <div id="rule-editor-content" style="display: none;">
                            <h2 id="rule-editor-title">Chỉnh Sửa Luật</h2>
                            <div class="form-group"><label for="rule-name-input">Tên Luật</label><input type="text" id="rule-name-input" placeholder="VD: Tăng Chí Mạng Khi Máu Thấp"></div>
                            <div class="rule-block"><h3 class="rule-block-title">NẾU (Tất cả điều kiện đúng)</h3><div id="rule-conditions-container"></div><button id="add-rule-condition-btn" class="btn btn-secondary btn-add-action">+ Thêm điều kiện</button></div>
                            <div class="rule-block"><h3 class="rule-block-title">THÌ (Thực hiện hành động)</h3><div id="rule-actions-container"></div><button id="add-rule-action-btn" class="btn btn-secondary btn-add-action">+ Thêm hành động</button></div>
                        </div>
                        <p id="logic-editor-placeholder">Chọn một mục từ cột trái để chỉnh sửa.</p>
                    </div>
                </div>
                <div id="entities-subpage" class="logic-sub-page">
                    <div class="logic-sidebar">
                        <div class="panel-section">
                            <h2>Danh sách Thực Thể</h2>
                            <ul id="entity-list"></ul>
                            <hr>
                            <div class="form-row">
                                <input type="text" id="new-entity-name" placeholder="Tên thực thể mới...">
                                <button id="add-entity-btn" class="btn btn-primary">Thêm</button>
                            </div>
                            <hr>
                            <div class="form-group">
                                <label>Giao Dịch Dữ Liệu Thực Thể</label>
                                <div class="btn-container" style="margin-top: 0;">
                                    <button id="import-entities-btn" class="btn btn-secondary">Import (.json)</button>
                                    <button id="export-entities-btn" class="btn btn-secondary">Export (.json)</button>
                                    <input type="file" id="import-entities-input" accept=".json" style="display: none;">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="entity-editor" class="panel-section">
                        <div id="entity-editor-content" style="display: none;">
                             <h2 id="entity-editor-title">Chỉnh sửa Thực Thể</h2>
                            <div class="form-group">
                                <label>Avatar</label>
                                <div class="image-preview-container avatar-preview">
                                    <img id="entity-avatar-preview" src="" class="image-preview" alt="Avatar Preview">
                                    <button id="clear-entity-avatar-btn" class="delete-btn" style="display: none;">X</button>
                                </div>
                                <input type="file" id="entity-avatar-upload" accept="image/*" class="image-upload-input">
                            </div>
                             <div class="form-group">
                                 <label for="entity-name-input">Tên Thực Thể</label>
                                 <input type="text" id="entity-name-input">
                             </div>
                             <hr>
                             <h3>Các biến số</h3>
                             <div id="entity-variables-list"></div>
                        </div>
                        <p id="entity-editor-placeholder">Chọn một thực thể từ cột trái để chỉnh sửa.</p>
                    </div>
                </div>
                <div id="logic-map-subpage" class="logic-sub-page">
                    <div id="logic-map-container"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="notification-toast"></div>
    <div id="result-modal"><div class="modal-content"><h2>Kết quả</h2><p id="result-text"></p><button id="close-modal-button" class="btn btn-primary">OK</button></div></div>
    <div id="confirmation-modal"></div>
    <datalist id="variable-suggestions-settings"></datalist>
    <datalist id="variable-suggestions-action"></datalist>
    <script src="script.js"></script>
</body>
</html>

